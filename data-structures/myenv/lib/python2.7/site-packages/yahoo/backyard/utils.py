from builtins import str
# vim: tabstop=4 shiftwidth=4 softtabstop=4

#    Copyright (C) 2012 Yahoo! Inc. All Rights Reserved.

import base64

from yahoo.backyard import BYCookie
from yahoo.backyard import exceptions as exc
from yahoo.backyard import PUB_KEY_FN

import requests


def extract(cookie_dict, key_filename=PUB_KEY_FN):
    for f in ['YBY', 'yby']:
        if f in cookie_dict:
            return BYCookie(cookie_dict[f], key_filename=key_filename)
    raise exc.BYMissingException()


def fetch_cookie(user, password, url, timeout, debuglevel=0,
                 key_filename=PUB_KEY_FN):
    post_params = {
        'id': user,
        'pass_word': base64.b64encode(password.encode('utf-8')),
        'action': 'login',
        'base64Encode': '1',
    }
    s = requests.Session()
    s.headers.update({
        'Content-Type': 'application/x-www-form-urlencoded',
    })
    s.post(url, timeout=timeout, data=post_params)
    cookies = {}
    for c in s.cookies:
        cookies[c.name] = str(c.value)
    return extract(cookies, key_filename=key_filename)
